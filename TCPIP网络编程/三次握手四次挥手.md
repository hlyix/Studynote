# TCP原理
## TCP套接字中的I/O缓冲
- I/O缓冲在每个TCP套接字中单独存在
- I/O缓冲在创建套接字时自动生成
- 即使关闭套接字仍然会传输遗留在输出缓冲区中的数据
- 关闭套接字会丢失输入缓冲区中的数据
- ![tcp缓冲](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1550906082822&di=834dd47fb0f682f3cbc697f0a5fdf584&imgtype=0&src=http%3A%2F%2Fseo-1255598498.file.myqcloud.com%2Ffull%2Fea521c12d6460d92fa11c05d0c26b35677e61dc8.jpg)

## TCP内部工作原理1：与对方套接字建立连接
**三次握手**
![TCP三次握手](https://images2017.cnblogs.com/blog/985821/201708/985821-20170802101806802-1497343688.png)
- 客户端发出syn=1，请求同步；并且发出序列seq=x，以及空的ACK信号
- 服务器收到，同时发出同步信号syn=1；并确认，发出ACK=1信号,以及确认号akc=x+1（要求客户接下来发x+1的序列包），seq=y
- 客户端确认收到后，发送ACK信号，以及seq=x+1序列，以及确认好ack=y+1（告诉服务器收到了序列号为y的序列，接下来可以发序列为y+1的数据包了）

**至于为什么要进行三次握手呢，主要是因为如果两次握手：**
- 客户第一次发的连接请求，滞后
- 客户机没收到服务器返回消息，于是重发连接请求
- 服务器收到第二次连接请求，于是打开端口，与客户机传输消息
- 突然客户机第一次的请求又发到了服务器，服务器打开端口，但是此端口客户一直没用上，就会造成空闲，浪费资源

如果三次连接的话，那么第二次到的信息号服务器确认后发给客户进行第三次握手，客户机不予理睬，那么这个端口就不会打开了！

## TCP内部工作原理2：与对方主机的数据交换
![tcp传输](https://upload-images.jianshu.io/upload_images/191918-fa53b954afc37181.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/438/format/webp)
>数据交换过程中：`ACK号 = SEQ号 + 传输的数据的字节数 + 1`

![TCP数据交换过程发生错误](https://upload-images.jianshu.io/upload_images/191918-81271b7d3443a160.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/403/format/webp)

## TCP内部工作原理3：断开与对方套接字的连接
**四次挥手**
![四次挥手](https://images2017.cnblogs.com/blog/985821/201708/985821-20170802101823505-1177747613.png)
- 1 客户机发送释放连接请求FIN，以及序列包seq = u，并停止再发送数据，主动关闭TCP连接，进入FIN-WAIT-1（终止等待1）状态，等待B的确认
- 2 **服务器收到连接释放报文段后即发出确认报文段，（ACK=1，确认号ack=u+1，序号seq=v），服务器进入CLOSE-WAIT（关闭等待）状态，此时的TCP处于半关闭状态，客户到服务的连接释放（也就是说客户端不会发信息了，但是可以收信息，类似于客户机shutdown状态）。**
- 3 服务器CLOSE-WAIT状态下，会检查有没有数据还要发送给客户，有的话就继续传输（客户机shutdown状态下还是可以接受数据的），没有的话就通知应用进程关闭程序，准备释放连接
- 4 当服务器没有数据传输后，放出释放连接信号FIN=1，ACK=1，seq = w，确认号ack = u+1。
- 5 客户机收到后，进入2msl的TIMEWAIT状态，并发出释放连接的确认信号（ACK=1，seq = u+1，ack = w+1）,此处的timewait是防止服务器没收到最终信号，从而重新发送第三次挥手，这样处于timewait状态下的客户机能收到服务器重发的挥手信号。
- **防止客户机关机了，客户机发送的第四次挥手丢失导致服务器关不了机！**
- **其次，A在发送完最后一个ACK报文段后，再经过2MSL，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失，使下一个新的连接中不会出现这种旧的连接请求报文段。**
- 6 最后服务器收到第四次挥手时，关闭连接。